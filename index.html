<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>XeinStore - Digital Game Codes</title>
    <style>
        * { box-sizing: border-box; margin:0; padding:0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; color:#222; }
        .header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding:1rem 0; box-shadow:0 2px 20px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100; }
        .nav { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding:0 2rem; }
        .logo { font-size:1.6rem; font-weight:700; background:linear-gradient(45deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .cart-btn { background:#667eea; color:#fff; border:none; padding:.6rem 1rem; border-radius:20px; cursor:pointer; font-weight:600; display:flex; gap:.5rem; align-items:center;}
        .cart-count { background:#ff4757; color:white; border-radius:50%; padding:.15rem .45rem; font-size:.8rem; }
        .container { max-width:1200px; margin:1.5rem auto; padding:1rem; }
        .hero { text-align:center; color:white; margin-bottom:1.5rem; }
        .hero h1 { font-size:2.4rem; text-shadow:2px 2px 4px rgba(0,0,0,0.25); margin-bottom:.3rem; }
        .products-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap:1.25rem; }
        .product-card { background: rgba(255,255,255,0.95); border-radius:12px; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.08); transition:transform .18s; }
        .product-card:hover { transform: translateY(-6px); }
        .product-image { height:150px; display:flex; align-items:center; justify-content:center; font-size:3rem; color:white; background: linear-gradient(45deg,#667eea,#764ba2); }
        .product-info { padding:1rem; }
        .product-title { font-weight:700; color:#2d3748; margin-bottom:.35rem; }
        .product-platform { color:#667eea; margin-bottom:.6rem; }
        .duration-selector select { width:100%; padding:.45rem; border-radius:6px; border:1px solid #e6eef8; margin-bottom:.5rem; }
        .duration-price { color:#667eea; font-weight:700; margin-bottom:.6rem; }
        .add-to-cart { width:100%; padding:.6rem; border-radius:8px; background:#667eea; color:white; border:none; cursor:pointer; font-weight:700; }
        /* cart sidebar */
        .cart-sidebar { position: fixed; right: -420px; top: 0; width: 420px; height: 100vh; background: white; box-shadow: -5px 0 20px rgba(0,0,0,.12); transition: right .28s; z-index:900; overflow-y:auto; }
        .cart-sidebar.open { right: 0; }
        .cart-header { padding:1rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        .close-cart { background:none; border:none; font-size:1.3rem; cursor:pointer; }
        .cart-items { padding:1rem; }
        .cart-item { display:flex; justify-content:space-between; gap:10px; padding:.75rem 0; border-bottom:1px solid #f1f3f5; align-items:center; }
        .cart-total { padding:1rem; border-top:2px solid #eee; font-weight:800; font-size:1.05rem; }
        .checkout-btn { width:100%; padding:1rem; border-radius:10px; background:#00d4aa; color:white; border:none; font-weight:800; cursor:pointer; margin-top:.8rem; }
        .notification { position: fixed; top: 20px; right: 20px; background: #00d4aa; color: white; padding: 1rem; border-radius: 8px; z-index:10000; }
        /* modal */
        .modal-backdrop { position:fixed; inset:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:10000; padding:1rem; }
        .modal-backdrop.open { display:flex; }
        .modal { width:100%; max-width:720px; background:white; border-radius:12px; overflow:auto; max-height:90vh; }
        .modal-header { padding:1rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:1rem; display:grid; gap:1rem; grid-template-columns: 1fr 320px; }
        .modal-column { padding:.5rem; }
        .field { margin-bottom:.6rem; }
        input[type="email"] { width:100%; padding:.6rem; border-radius:8px; border:1px solid #e6edf7; }
        .qr-card { border:1px dashed #e6edf7; padding:1rem; border-radius:8px; text-align:center; }
        .network-label { font-weight:700; margin-bottom:.4rem; }
        .small { font-size:.9rem; color:#666; }
        .btn { padding:.6rem .9rem; border-radius:8px; border:none; cursor:pointer; }
        .btn-primary { background:#667eea; color:white; font-weight:700; }
        .btn-success { background:#00d4aa; color:white; font-weight:800; }
        .btn-danger { background:#ff4757; color:white; }
        .orders-admin { position:fixed; left:12px; bottom:12px; z-index:2000; }
        .orders-admin button { padding:.6rem .85rem; border-radius:8px; border:none; cursor:pointer; background:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.08); }
        .small-muted { font-size:.85rem; color:#666; }
        @media (max-width:900px) {
            .modal-body { grid-template-columns: 1fr; }
            .cart-sidebar { width:100%; right:-100%; }
            .cart-sidebar.open { right:0; width:100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">ðŸŽ® XeinStore</div>
            <div style="display:flex; gap:.6rem; align-items:center;">
                <button class="cart-btn" onclick="toggleCart()">Cart <span class="cart-count" id="cart-count">0</span></button>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="hero">
            <h1>Digital Game Codes</h1>
            <p>Instant delivery â€¢ USDT (TRC20) â€¢ Best prices</p>
        </div>

        <div class="products-grid" id="products-grid"></div>
    </main>

    <!-- Cart sidebar -->
    <aside class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3>Shopping Cart</h3>
            <button class="close-cart" onclick="toggleCart()">Ã—</button>
        </div>
        <div class="cart-items" id="cart-items">
            <p style="text-align:center; color:#666; padding:2rem;">Your cart is empty</p>
        </div>
        <div class="cart-total" id="cart-total" style="display:none;">Total: $0.00</div>
        <div style="padding:1rem;">
            <button id="checkout-btn" class="checkout-btn" style="display:none;" onclick="openCheckoutModal()">Pay with USDT</button>
        </div>
    </aside>

    <!-- Checkout modal -->
    <div class="modal-backdrop" id="checkout-modal">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="checkout-title">
            <div class="modal-header">
                <h3 id="checkout-title">Checkout</h3>
                <div>
                    <button class="btn" onclick="closeCheckoutModal()">Close</button>
                </div>
            </div>

            <div class="modal-body">
                <div class="modal-column">
                    <div class="field">
                        <label class="small-muted">Your email (required)</label>
                        <input id="buyer-email" type="email" placeholder="you@example.com" />
                    </div>

                    <div id="order-summary" style="border:1px solid #f0f3f7; padding:.75rem; border-radius:8px;">
                        <!-- order summary filled by JS -->
                    </div>

                    <div style="margin-top:.6rem; display:flex; gap:.6rem;">
                        <button class="btn btn-primary" id="show-qr-btn" onclick="preparePayment()" style="flex:1;">Continue to Payment</button>
                        <button class="btn" onclick="closeCheckoutModal()">Cancel</button>
                    </div>

                    <div style="margin-top:1rem;">
                        <p class="small-muted">After you send USDT (TRC20) to the address shown, click "I PAID" and optionally upload a screenshot. You will receive a receipt by email (if email sending is configured).</p>
                    </div>
                </div>

                <!-- Right column: QR + wallet -->
                <div class="modal-column">
                    <div id="payment-pane" style="display:none;">
                        <div class="qr-card">
                            <div class="network-label">Network: <span style="color:#222; font-weight:800;">Tron (TRC20)</span></div>
                            <div style="margin:.6rem 0;" id="wallet-address" class="small-muted">TEwKbkNdXqvNUG951nYTCRF6UjLGBn7pqc</div>
                            <div>
                                <img id="qr-img" alt="QR code" src="" style="width:220px; height:220px; object-fit:contain; border-radius:6px;" />
                            </div>
                            <div style="margin-top:.6rem; display:flex; gap:.5rem; justify-content:center;">
                                <button class="btn" onclick="copyWallet()">Copy Address</button>
                                <button class="btn btn-success" id="paid-btn" onclick="markAsPaid()">I PAID</button>
                            </div>
                            <div id="upload-screenshot" style="margin-top:.6rem; display:none;">
                                <label class="small-muted">Upload proof (optional)</label>
                                <input type="file" id="proof-file" accept="image/*" />
                            </div>
                        </div>

                        <div style="margin-top:.75rem; display:flex; gap:.5rem;">
                            <button class="btn btn-primary" onclick="sendReceiptEmail()">Send Receipt Now / Email</button>
                            <button class="btn" onclick="downloadReceipt()">Download Receipt</button>
                        </div>

                        <div style="margin-top:.75rem;">
                            <div id="payment-state" class="small-muted">Status: <span id="payment-status">Awaiting payment</span></div>
                        </div>
                    </div>

                    <div id="after-paid" style="display:none; text-align:center;">
                        <h4 style="margin-top:.6rem;">Payment Received</h4>
                        <p class="small-muted">Thank you â€” an email receipt was sent (if configured).</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin / Export orders -->
    <div class="orders-admin">
        <button onclick="openOrdersPanel()">Orders â–¾</button>
    </div>

    <!-- Orders panel modal (simple) -->
    <div id="orders-panel" class="modal-backdrop" style="display:none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Saved Orders</h3>
                <div><button class="btn" onclick="closeOrdersPanel()">Close</button></div>
            </div>
            <div style="padding:1rem;">
                <div style="margin-bottom:.75rem; display:flex; gap:.5rem;">
                    <button class="btn" onclick="exportOrders()">Export as JSON</button>
                    <button class="btn" onclick="clearOrders()">Clear Orders</button>
                </div>
                <div id="orders-list" style="max-height:60vh; overflow:auto; border-top:1px solid #f1f3f7; padding-top:.75rem;"></div>
            </div>
        </div>
    </div>

    <!-- Optional: include EmailJS SDK (only needed if you want automatic email) -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <script>
        // ---------- CONFIG ----------
        const TRON_ADDRESS = "TEwKbkNdXqvNUG951nYTCRF6UjLGBn7pqc"; // your TRC20 deposit address
        // QR generator: data is the address (you can replace with your own hosted image if desired)
        function qrUrlFromAddress(addr) {
            const encoded = encodeURIComponent(addr);
            // using a public QR generator
            return `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encoded}`;
        }

        // EmailJS configuration - REPLACE with your own EmailJS user/service/template IDs to enable automatic email sending.
        const EMAILJS_USER_ID = "YOUR_EMAILJS_USER_ID";        // <<--- put your EmailJS user ID here
        const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID";         // <<--- your EmailJS service ID
        const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID";       // <<--- your EmailJS template ID

        // If you configure EmailJS, init it:
        if (typeof emailjs !== "undefined" && EMAILJS_USER_ID !== "YOUR_EMAILJS_USER_ID") {
            emailjs.init(EMAILJS_USER_ID);
        }

        // ---------- PRODUCTS ----------
        const products = [
            { id:1, title:"Xein Pubg Key", platform:"Digital Key", pricing:{"1_day":{price:5.00},"3_days":{price:8.00},"7_days":{price:12.00},"14_days":{price:17.00},"30_days":{price:23.00}}, icon:"ðŸŽ¯" },
            { id:2, title:"Xein Delta Force Key", platform:"Digital Key", pricing:{"1_day":{price:4.00},"3_days":{price:7.00},"7_days":{price:11.00},"14_days":{price:16.00},"30_days":{price:22.00}}, icon:"âš¡" }
        ];
        let cart = [];

        // render product cards
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = '';
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                let optionsHTML = '';
                for (const [key, v] of Object.entries(product.pricing)) {
                    const label = key.replace(/_/g,' ').replace(/\b\w/g,l => l.toUpperCase());
                    optionsHTML += `<option value="${key}">${label} - $${v.price}</option>`;
                }
                card.innerHTML = `
                    <div class="product-image">${product.icon}</div>
                    <div class="product-info">
                        <div class="product-title">${product.title}</div>
                        <div class="product-platform">${product.platform}</div>
                        <div class="duration-selector">
                            <select id="duration-${product.id}" onchange="updatePrice(${product.id})">
                                ${optionsHTML}
                            </select>
                            <div class="duration-price" id="price-${product.id}">$${product.pricing["1_day"].price} USDT</div>
                        </div>
                        <button class="add-to-cart" onclick="addToCart(${product.id})">Add to Cart</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function updatePrice(productId) {
            const select = document.getElementById(`duration-${productId}`);
            const priceDisplay = document.getElementById(`price-${productId}`);
            const product = products.find(p => p.id===productId);
            priceDisplay.textContent = `$${product.pricing[select.value].price} USDT`;
        }

        function addToCart(productId) {
            const product = products.find(p => p.id===productId);
            const select = document.getElementById(`duration-${productId}`);
            const selectedDuration = select.value;
            const price = product.pricing[selectedDuration].price;

            const existing = cart.find(i => i.id===productId && i.selectedDuration===selectedDuration);
            if (existing) existing.quantity++;
            else cart.push({ id:product.id, title:product.title, selectedDuration, durationLabel:select.options[select.selectedIndex].text, price, quantity:1 });

            updateCartUI();
            showNotification('Added to cart âœ…');
        }

        // UI helpers
        function showNotification(msg) {
            const n = document.createElement('div'); n.className='notification'; n.textContent=msg;
            document.body.appendChild(n);
            setTimeout(()=> { if (n.parentNode) n.parentNode.removeChild(n); }, 2000);
        }

        function updateCartUI() {
            const cartCount = document.getElementById('cart-count');
            const cartItems = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');

            const totalItems = cart.reduce((s,i)=>s+i.quantity,0);
            const totalPrice = cart.reduce((s,i)=>s + i.price*i.quantity,0);

            cartCount.textContent = totalItems;

            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align:center;color:#666;padding:2rem;">Your cart is empty</p>';
                cartTotalEl.style.display = 'none';
                checkoutBtn.style.display = 'none';
            } else {
                let html = '';
                for (const item of cart) {
                    html += `
                        <div class="cart-item">
                            <div style="flex:1;">
                                <div style="font-weight:700;">${item.title}</div>
                                <div style="font-size:.9rem;color:#666;">${item.durationLabel}</div>
                                <div style="font-size:.9rem;color:#667eea;">$${item.price} each x${item.quantity}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:.4rem;">
                                <button onclick="decreaseQty(${item.id},'${item.selectedDuration}')" style="padding:.35rem .5rem;">âˆ’</button>
                                <button onclick="increaseQty(${item.id},'${item.selectedDuration}')" style="padding:.35rem .5rem;">+</button>
                                <button onclick="removeFromCart(${item.id},'${item.selectedDuration}')" style="background:#ff4757;color:white;border:none;border-radius:6px;padding:.35rem .5rem;cursor:pointer;">Remove</button>
                            </div>
                        </div>
                    `;
                }
                cartItems.innerHTML = html;
                cartTotalEl.style.display = 'block';
                cartTotalEl.textContent = `Total: $${totalPrice.toFixed(2)} USDT`;
                checkoutBtn.style.display = 'block';
            }
        }

        function decreaseQty(id,dur) {
            const idx = cart.findIndex(i=>i.id===id && i.selectedDuration===dur);
            if (idx>-1) {
                cart[idx].quantity = Math.max(1, cart[idx].quantity-1);
                updateCartUI();
            }
        }
        function increaseQty(id,dur) {
            const idx = cart.findIndex(i=>i.id===id && i.selectedDuration===dur);
            if (idx>-1) { cart[idx].quantity++; updateCartUI(); }
        }
        function removeFromCart(id,dur) {
            cart = cart.filter(i => !(i.id===id && i.selectedDuration===dur));
            updateCartUI();
        }

        function toggleCart() {
            document.getElementById('cart-sidebar').classList.toggle('open');
        }

        // ---------- Checkout logic ----------
        function openCheckoutModal() {
            if (cart.length === 0) { alert('Cart is empty.'); return; }
            document.getElementById('checkout-modal').classList.add('open');
            renderOrderSummary();
        }
        function closeCheckoutModal() {
            document.getElementById('checkout-modal').classList.remove('open');
            // reset payment pane
            document.getElementById('payment-pane').style.display='none';
            document.getElementById('after-paid').style.display='none';
            document.getElementById('payment-status').textContent = 'Awaiting payment';
        }

        function renderOrderSummary() {
            const el = document.getElementById('order-summary');
            let html = '<div style="font-weight:800;margin-bottom:.5rem;">Order Summary</div>';
            const items = cart.map(i => `<div style="display:flex;justify-content:space-between;"><div>${i.title} (${i.durationLabel}) x${i.quantity}</div><div>$${(i.price*i.quantity).toFixed(2)}</div></div>`).join('');
            const total = cart.reduce((s,i)=>s + i.price*i.quantity,0).toFixed(2);
            html += items;
            html += `<div style="border-top:1px dashed #eee;margin-top:.6rem;padding-top:.6rem;font-weight:800;display:flex;justify-content:space-between;"> <div>Total</div><div>$${total} USDT</div></div>`;
            el.innerHTML = html;
        }

        // Called when buyer clicks Continue to Payment
        function preparePayment() {
            const email = document.getElementById('buyer-email').value.trim();
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            // populate QR & wallet with the TRC20 address
            const qr = document.getElementById('qr-img');
            qr.src = qrUrlFromAddress(TRON_ADDRESS);
            document.getElementById('wallet-address').textContent = TRON_ADDRESS;
            document.getElementById('payment-pane').style.display='block';
            document.getElementById('upload-screenshot').style.display='block';
            // auto-generate the receipt object (unconfirmed)
            generateReceiptObject(email);
        }

        // Receipt creation and saving to localStorage
        function generateReceiptObject(buyerEmail) {
            const orderId = 'XSN' + Date.now(); // simple unique id
            const timestamp = new Date().toISOString();
            const items = cart.map(i => ({ id:i.id, title:i.title, duration:i.durationLabel, quantity:i.quantity, unitPrice:i.price, lineTotal:(i.price*i.quantity) }));
            const total = items.reduce((s,i)=>s+i.lineTotal,0);
            const receipt = {
                orderId,
                timestamp,
                buyerEmail,
                items,
                total,
                walletAddress: TRON_ADDRESS,
                network: "Tron (TRC20)",
                status: "awaiting_payment",
            };
            // save to localStorage orders list
            saveOrderLocally(receipt);
            // show in modal for further actions
            window.currentReceipt = receipt; // keep reference
            showReceiptSnippet(receipt);
        }

        function saveOrderLocally(receipt) {
            let arr = JSON.parse(localStorage.getItem('xein_orders') || '[]');
            arr.push(receipt);
            localStorage.setItem('xein_orders', JSON.stringify(arr));
        }

        function showReceiptSnippet(receipt) {
            const pane = document.getElementById('order-summary');
            // append short receipt info
            const extra = document.createElement('div');
            extra.style.marginTop = '.6rem';
            extra.innerHTML = `<div style="font-size:.95rem;"><strong>Order ID:</strong> ${receipt.orderId}<br><strong>Email:</strong> ${receipt.buyerEmail}</div>`;
            pane.appendChild(extra);
        }

        // Copy wallet to clipboard
        function copyWallet() {
            navigator.clipboard.writeText(TRON_ADDRESS).then(()=> showNotification('Address copied âœ…'), ()=> alert('Copy failed'));
        }

        // Mark as paid (manual)
        function markAsPaid() {
            if (!window.currentReceipt) return alert('No order found.');
            // optionally attach uploaded proof
            const fileEl = document.getElementById('proof-file');
            if (fileEl && fileEl.files && fileEl.files.length>0) {
                // convert to base64 for storage (small images OK)
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.currentReceipt.proofImage = e.target.result;
                    finalizePaymentMark();
                };
                reader.readAsDataURL(fileEl.files[0]);
            } else {
                finalizePaymentMark();
            }
        }

        function finalizePaymentMark() {
            window.currentReceipt.status = 'paid_pending_verification';
            // update localStorage (replace last matching orderId)
            let arr = JSON.parse(localStorage.getItem('xein_orders') || '[]');
            const idx = arr.findIndex(o => o.orderId === window.currentReceipt.orderId);
            if (idx > -1) { arr[idx] = window.currentReceipt; localStorage.setItem('xein_orders', JSON.stringify(arr)); }
            document.getElementById('payment-status').textContent = 'Marked as PAID (pending verification)';
            document.getElementById('after-paid').style.display='block';
            showNotification('Marked as paid. You will need to verify manually.');
            // attempt to send email receipt if configured
            sendReceiptEmail();
        }

        // ------ Sending receipt via EmailJS (optional) ------
        // NOTE: To make email sending work:
        //   1) Create an account at https://www.emailjs.com
        //   2) Create an email service (like Gmail/SMTP)
        //   3) Create an email template with placeholders: orderId, buyerEmail, itemsHtml, total, walletAddress, network, timestamp
        //   4) Fill the EMAILJS_USER_ID, EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID variables above.
        // Template example: Order {{orderId}} ... {{itemsHtml}} ... Total {{total}}
        async function sendReceiptEmail() {
            if (!window.currentReceipt) return alert('No order/receipt available to send.');

            // prepare items HTML
            const itemsHtml = window.currentReceipt.items.map(i => `${i.title} (${i.duration}) x${i.quantity} - $${i.lineTotal.toFixed(2)}`).join('<br>');
            const templateParams = {
                orderId: window.currentReceipt.orderId,
                buyerEmail: window.currentReceipt.buyerEmail,
                itemsHtml,
                total: window.currentReceipt.total.toFixed(2),
                walletAddress: window.currentReceipt.walletAddress,
                network: window.currentReceipt.network,
                timestamp: window.currentReceipt.timestamp
            };

            if (typeof emailjs !== "undefined" && EMAILJS_USER_ID !== "YOUR_EMAILJS_USER_ID" && EMAILJS_SERVICE_ID && EMAILJS_TEMPLATE_ID) {
                try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                    showNotification('Receipt emailed âœ…');
                    // update local order status to email_sent
                    updateOrderStatus(window.currentReceipt.orderId, 'email_sent');
                } catch (err) {
                    console.error(err);
                    alert('Email sending failed. Check EmailJS credentials in the code console.');
                }
            } else {
                // fallback: offer to download receipt as file and inform seller
                alert('EmailJS not configured. The receipt will be available to download and saved locally for you to check.');
            }
        }

        function updateOrderStatus(orderId, newStatus) {
            let arr = JSON.parse(localStorage.getItem('xein_orders') || '[]');
            const idx = arr.findIndex(o => o.orderId === orderId);
            if (idx>-1) { arr[idx].status = newStatus; localStorage.setItem('xein_orders', JSON.stringify(arr)); }
        }

        // download receipt as text file
        function downloadReceipt() {
            if (!window.currentReceipt) return alert('No receipt available.');
            const r = window.currentReceipt;
            let text = `XeinStore Receipt\nOrder ID: ${r.orderId}\nTimestamp: ${r.timestamp}\nEmail: ${r.buyerEmail}\nNetwork: ${r.network}\nWallet: ${r.walletAddress}\n\nItems:\n`;
            r.items.forEach(i => { text += `${i.title} (${i.duration}) x${i.quantity} - $${i.lineTotal.toFixed(2)}\n`; });
            text += `\nTotal: $${r.total.toFixed(2)} USDT\n\nStatus: ${r.status}\n`;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${r.orderId}_receipt.txt`; a.click();
            URL.revokeObjectURL(url);
        }

        // ---------- Orders admin functions ----------
        function openOrdersPanel() {
            const panel = document.getElementById('orders-panel');
            panel.style.display = 'flex';
            renderOrdersList();
        }
        function closeOrdersPanel() { document.getElementById('orders-panel').style.display='none'; }

        function renderOrdersList() {
            const listEl = document.getElementById('orders-list');
            const arr = JSON.parse(localStorage.getItem('xein_orders') || '[]').slice().reverse();
            if (!arr.length) { listEl.innerHTML = '<p class="small-muted">No orders yet.</p>'; return; }
            listEl.innerHTML = arr.map(o => {
                const items = o.items.map(it => `${it.title} (${it.duration}) x${it.quantity} = $${it.lineTotal.toFixed(2)}`).join('<br>');
                return `<div style="padding:.6rem;border-bottom:1px solid #f1f3f7;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div><strong>${o.orderId}</strong> <span class="small-muted">- ${new Date(o.timestamp).toLocaleString()}</span></div>
                        <div><strong>$${o.total.toFixed(2)}</strong></div>
                    </div>
                    <div style="margin-top:.45rem;" class="small-muted">Email: ${o.buyerEmail} â€¢ Status: ${o.status}</div>
                    <div style="margin-top:.5rem;">${items}</div>
                    ${o.proofImage ? `<div style="margin-top:.5rem;"><img src="${o.proofImage}" style="max-width:200px;border-radius:6px;" /></div>` : ''}
                </div>`;
            }).join('');
        }

        function exportOrders() {
            const arr = JSON.parse(localStorage.getItem('xein_orders') || '[]');
            const blob = new Blob([JSON.stringify(arr, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'xein_orders.json'; a.click();
            URL.revokeObjectURL(url);
        }

        function clearOrders() {
            if (!confirm('Clear all saved orders?')) return;
            localStorage.removeItem('xein_orders');
            renderOrdersList();
        }

        // ---------- Init ----------
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();
            updateCartUI();
            document.getElementById('wallet-address').textContent = TRON_ADDRESS;
            document.getElementById('qr-img').src = qrUrlFromAddress(TRON_ADDRESS);
        });

    </script>
</body>
</html>
